name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  IMAGE_REGISTRY: quay.io
  QUAY_NAMESPACE: ranper3110

  FRONTEND_IMAGE: guestbook-frontend
  BACKEND_IMAGE: guestbook-backend

  CONFIG_REPO: ranper85/rani-guestbook-app-config

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG="1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "Generated tag: ${IMAGE_TAG}"

      # ---------- FRONTEND ----------
      - name: Build and push FRONTEND image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Containerfile
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:latest

      # ---------- BACKEND ----------
      - name: Build and push BACKEND image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Containerfile
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:latest

      # ---------- UPDATE CONFIG REPO ----------
      - name: Update Kubernetes manifests
        run: |
          set -e

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ env.CONFIG_REPO }}.git config-repo
          cd config-repo

          FRONTEND_IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:${{ steps.image-tag.outputs.tag }}"
          BACKEND_IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:${{ steps.image-tag.outputs.tag }}"

          # My exact filenames:
          sed -i "s|^\(\s*image:\s*\).*guestbook-frontend:.*|\1${FRONTEND_IMAGE_FULL}|g" k8s/frontend.deployment.yaml
          sed -i "s|^\(\s*image:\s*\).*guestbook-backend:.*|\1${BACKEND_IMAGE_FULL}|g" k8s/backend.deployment.yaml

          git add k8s/frontend.deployment.yaml k8s/backend.deployment.yaml
          git commit -m "Update images to ${{ steps.image-tag.outputs.tag }}"
          git push origin main

